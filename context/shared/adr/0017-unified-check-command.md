# ADR-0017: Unified Check Command

## Status
Accepted

## Context

Portolan currently has two validation commands with overlapping purposes:

- **`scan`** — Validates directory structure for import readiness (no `.portolan/` required)
- **`check`** — Validates existing Portolan catalog (requires `.portolan/`)

This separation creates user confusion:
- Users must remember which command to use based on whether a catalog exists
- Both commands validate structure, but using different terminology
- The conceptual model is unclear: "Do I scan then check? Or check first?"

Additionally, ADR-0016 established a "scan-before-import" pattern but kept the commands separate. Practice has shown this adds friction without proportional benefit.

**Related issues:**
- [#80](https://github.com/portolan-sdi/portolan-cli/issues/80): Unify scan + check into single command
- [#74](https://github.com/portolan-sdi/portolan-cli/issues/74): Add .parquet to GEO_ASSET_EXTENSIONS

## Decision

### 1. Unified `check` Command

**Merge `scan` and `check` into a single `check` command** that validates directory structure:

| Input State | `check` Behavior |
|-------------|------------------|
| Any directory | Validate directory structure for geo-assets |
| Path doesn't exist | Error: "Path does not exist" |
| Path is a file | Error: "Path must be a directory" |

### 2. Standard STAC Layout (Deprecate `.portolan/` Convention)

The `.portolan/` hidden directory convention is **deprecated**. Portolan will adopt standard STAC catalog layout:

```
my-data/
├── catalog.json          # STAC Catalog (root)
├── census/
│   ├── collection.json   # STAC Collection
│   └── item.json         # STAC Item (links to assets)
└── data.parquet          # Asset files
```

**Rationale:**
- Standard STAC layout works with existing tools (PySTAC, stac-browser, STAC validators)
- No "Portolan-specific" format to learn
- Catalogs are generated during `sync`, not created upfront via `init`

### 3. Deferred Catalog Validation

Catalog validation (STAC field checks, link integrity) is **deferred** until the `sync` command is implemented:
- `check` validates input directory structure only
- `sync` will generate valid STAC catalogs and can validate its own output
- The `portolan_cli/validation/` module is deprecated pending removal

### 4. Remove `dataset` Subcommand Group

The `dataset` subcommand group (`add`, `list`, `info`, `remove`) is removed:
- These operations will be handled differently in the sync workflow
- Reduces CLI surface area
- Library functions retained for future use

### 5. Structure Validation Rules

**One primary asset per directory:**
- 0 assets → OK (empty directories are fine)
- 1 asset → OK
- 2+ assets → **ERROR** (blocking, requires manual reorganization)

The hint message for multiple assets is: "Manually reorganize so each directory has 1 geo-asset"

This is a blocking error because:
- Portolan cannot automatically determine which asset maps to which dataset
- User intent is ambiguous
- Silent merge or split could corrupt catalog semantics

### 6. Exit Code Semantics

| Scenario | Exit Code | JSON `success` |
|----------|-----------|----------------|
| No issues | 0 | `true` |
| Warnings only | 0 | `true` |
| Errors (blocking) | 1 | `false` |

Agents can check exit code for quick pass/fail, parse JSON for details.

### 7. Final Command Set

| Command | Purpose |
|---------|---------|
| `check` | Validate directory structure for geo-assets |
| `sync` | Convert, generate STAC catalog, upload (future) |

Note: `init` is removed since catalogs are generated by `sync`.

## Consequences

### Easier

- **Simpler mental model**: One command for structure validation
- **Standard STAC**: No Portolan-specific catalog format
- **Fewer choices**: Users don't need to remember scan vs check
- **Cleaner output**: Single result format

### Harder

- **Existing scripts using `scan`**: Must update to use `check`
- **Documentation updates**: All references to `scan` and `.portolan/` must be updated

### Trade-offs

- Catalog validation deferred (acceptable since `sync` doesn't exist yet)
- `init` command removed (catalogs generated during sync)

## Alternatives Considered

### 1. Keep `.portolan/` Convention

Continue using hidden directory for Portolan-managed files.

**Rejected because**: Adds unnecessary indirection. Standard STAC layout is simpler and more interoperable.

### 2. Keep Separate Commands, Improve Naming

Rename `scan` to `validate-structure` and `check` to `validate-catalog`.

**Rejected because**: Still requires users to know which to use. Adds cognitive load.

### 3. Require Explicit Mode Flag

`portolan check . --mode=structure` or `--mode=catalog`

**Rejected because**: Unnecessary complexity. Structure validation is the only mode for now.

## Supersedes

- **ADR-0016** (Scan-before-import): The principle of validating before import remains, but the implementation is now a single `check` command.
